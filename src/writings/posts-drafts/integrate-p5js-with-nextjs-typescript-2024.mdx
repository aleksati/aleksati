---
title: "How to integrate p5js into your Nextjs TypeScript Projects in 2024"
date: "2024-01-30"
keywords:
  [
    "p5js",
    "next",
    "web",
    "react",
    "typescript",
    "audio",
    "programming",
    "javascript",
    "visuals",
    "nodejs",
  ]
type: "post"
summary: "On my website, I use the p5js library to make little audio-visual widgets. Recently, I decided to redesign and update my p5 and p5-sounds implementation to support newer versions of p5, React, Nextjs (v14.1), and TypeScript. Click to read more about how you can do it."
---

As web development libraries age and update, so must developers. In this spirit, I recently modernized my entire Nextjs website infrastructure and migrated from JavaScript to TypeScript. As expected, many things broke in the process and I soon found myself completely re-designing some of the more complex components I built for my site.

In my posts, I sometimes use the p5js library to create cool little audio-visual widgets and sonification examples. Updating my broken <MyLink href="https://p5js.org/">p5js</MyLink> implementation was challenging on many levels. The standard p5 library for react users (<MyLink href="https://www.npmjs.com/package/react-p5">p5-react</MyLink>) is currently deprecated, and the standard p5 library is not particularly up-to-date, nor well-designed for Nextjs server-side rendering framework. And that's not even mentioning the web-audio related issues. Luckily, after some head-scratching and rigorous online forum reading, I managed to scrape together a system that works.

Since I had to draw code and inspiration from a variety of online sources, I thought it would nice to share what I did and possibly help others in similar situations. So this is how I integrated p5js and p5-sounds into my Nextjs React TypeScript project in 2024.

```
Versions used:
p5 - v1.9.0 and p5.sounds - v0.9.0
Nextjs - v14.1.0
React - v18.2.0
Node - v20.11.0
TypeScript - v5.3.3
```

# Contents

1. <MyLink href="#p5-container-component">p5 Container Component</MyLink>
2. <MyLink href="#importing-p5-and-p5.sounds-client-side">
     Importing p5 and p5.sounds Client-side
   </MyLink>
3. <MyLink href="#building-p5-apps">Building p5 Apps</MyLink>
4. <MyLink href="#full-code-and-working-example">
     Full Code and Working Example
   </MyLink>
5. <MyLink href="#references-and-inspirations">
     References and Inspirations
   </MyLink>

---

# p5 Container Component

First, install the p5 library "npm install p5" from the root of your Nextjs project. Then, create a p5 container component. The container acts as a Higher-Order Component for our p5 apps (sketches), putting all the React and Nextjs rendering logic in one place, meaning the code in the sketches can be 100% p5-focused.

The container component takes p5 sketches as props. By using the p5Types class import that follows the p5 npm install, we can provide accurate typing for our sketches and p5 instances. Each p5 sketch is given a unique p5 instance and a reference to the container div (parentRef) as props. Inside each sketch, the parentRef is reference to create the p5 visual canvas. More on this later.

```TypeScript
// components/P5jsContainer.tsx
import React, { useEffect, useRef } from "react";
import p5Types from "p5";

// can go in "./types/global.d.ts"
type P5jsContainerRef = HTMLDivElement;
type P5jsSketch = (p: p5Types, parentRef: P5jsContainerRef) => void;

const P5jsContainer = ({ sketch }: { sketch: P5jsSketch }): React.JSX.Element => {
  const parentRef = useRef<P5jsContainerRef>();

  // More stuff come here
  // ....
  // ...

  // parent div of the p5 canvas
  return <div ref={parentRef}></div>;
};

export default P5jsContainer;

```

# Importing p5 and p5.sounds

Because of the full-stack architecture of Nextjs, there is no current support for importing the standard p5 library as a normal react library (e.i server-side). Instead, p5 has to be added on the client side. The most common approach for this client-side import with Nextjs is to use the Next Dynamic function to achieve lazy loading. However, I was unsuccessful with the method as there apparently are some compatibility issues with the standard p5 library and the Nextjs framework, at least with my environment versions stated above.

Instead, what worked was to import p5 as a render side-effect through React's useEffect function. So when the component has mounted, I import p5 and p5.sounds, create a new p5 instance and pass it as a prop to my sketch.

Inside the sketches, we will use the

```TypeScript
// components/P5jsContainer.tsx
  // ...
  const [isMounted, setIsMounted] = useState<boolean>(false)

  // on mount
  useEffect(() => {
    setIsMounted(true);
  }, [])

  useEffect(() => {
    // if not mounted, do nothing yet.
    if (!isMounted) return;

    // our current p5 sketch instance
    let p5instance: p5Types;

    // function that loads p5 and creates the sketch inside the div.
    const initP5 = async () => {
      try {
        // import the p5 and p5.sounds client-side
        const p5 = (await import("p5")).default;
        await import("p5/lib/addons/p5.sound");
        // initalize the sketch
        new p5((p) => {
          sketch(p, parentRef.current);
          p5instance = p;
        });
      } catch (error) {
        console.log(error);
      }
    };

    initP5();

    // when the component unmounts, remove the p5 instance.
    return p5instance.remove();

  }, [isMounted, sketch]);
// ....
```

Notice that the p5 sounds library in the code block above is imported in the same mannor, a library that is necessary for using the web audio capabilities of p5. However, you may encounter reference errors and other troubles when importing p5.sounds like this on the newest versions of Nextjs (v.14.1.0) and p5 (v1.9.0). If so, see the alternative way to import p5.sounds below.

# Alternative p5.sounds Import

To find a solution to my p5.sounds import problem, I roamed the internet for possible fixes. Luckily, I came across <MyLink href="https://stackoverflow.com/questions/61985249/how-to-import-and-utilize-p5-sound-in-vue">this genius answer</MyLink> by Bob McBobson in 2020, in response to an issue with the p5 sounds not being recognized in Vue. Bob suggests simply using an older version of p5.sounds together with the latest version of p5. This worked perfectly for me.

First use "npm uninstall p5" and "npm install p5@0.9.0" to downgrade your p5 version to version 0.9.0. Then, copy the downgraded version of "p5.sound.js" from node_modules to a custom folder in your root directory, such as "./lib". Once you have copied the file, use "npm uninstall p5" and "npm install p5@latest" again to upgrade your p5 to the latest version. Finally, change the import statement in your components to point to your custom folder with the older version of p5.sounds:

```TypeScript
// components/P5jsContainer.tsx
await import("../lib/p5.sound");
```

# Building p5 Apps

With the container component ready, it's time to start building p5 sketches/apps. With the current setup, we have to use the instance mode structure of p5 when writing sketches. In this mode, each sketch is essentially a function that receives a unique p5 class instance as an argument. This ensures that multiple sketches can be used on the same page and through your website, among other things. My setup also extends this structure a little bit by adding a reference to the container element as the second argument. With the parentRef, we can create each sketch neatly inside the p5 container, enable dynamic resizing, and much more.

One important thing to note about most modern browsers is that they will not allow the web audio context to start without a user gesture, such as in response to a button or mouse-click event. One example of how to do this is to access the audioContext from the p5 class instance and resume its audioContext through the canvas.mouseClick event.

```TypeScript
//sketches/mysketch.ts
let parentStyle: CSSStyleDeclaration;
let canvasHeight: number;
let canvasWidth: number;
let audioState: string;
let cnv: any;

// can go in "./types/global.d.ts"
type P5jsContainerRef = HTMLDivElement;
type P5jsSketch = (p: p5Types, parentRef: P5jsContainerRef) => void;

export const mySketch: P5jsSketch = (p5, parentRef) {
  p5.setup = () => {
    // get and set the canvas size inside the parent
    parentStyle = window.getComputedStyle(parentRef);
    canvasWidth = parseInt(parentStyle.width) * 0.99;
    canvasHeight = parseInt(parentStyle.width) * 0.4;
    cnv = p5.createCanvas(canvasWidth, canvasHeight).parent(parentRef);

    // suspend audioContext from the start (standard for modern browsers)
    audioState = p5.getAudioContext();
    audioState.suspend();
    cnv.mouseClicked(() => {
      audioState.state !== "running" ? audioState.resume() : null;
    });
    // etc....
  };

  p5.draw = () => {
    // draw stuff on the screen
  }
}

```

It's possible to also build more elaborate sketches by creating custom classes. This works fine, just remember to type them as extending the React.component class.

# Full Code and Working Example

Kanskjer bare link til min andre post..

# References and Inspirations

Lloyd Atkinson - How to Prevent a Duplicated Canvas When Using P5 and React Strict Mode (TypeScript)
https://www.lloydatkinson.net/posts/2022/how-to-prevent-a-duplicated-canvas-when-using-p5-and-react-strict-mode/

p5 constructor
https://github.com/P5-wrapper/react/issues/61

p5 with next and typescript
https://github.com/alecrem/nextjs-p5js-tutorial
